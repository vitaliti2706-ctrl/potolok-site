<script>
// ===== Helpers =====
function num(v){ var n = +v; return isFinite(n) ? n : 0; }
function UAH(n){ return new Intl.NumberFormat('uk-UA').format(Math.round(n)); }
function $(id){ return document.getElementById(id); }

// ===== Глобальні ціни з JSON =====
let PR = null;

async function loadPrices(){
  const resp   = await fetch('prices.json');
  const prices = await resp.json();
  console.log('Ціни завантажені:', prices);
  return prices;
}

// ===== Основний перерахунок =====
function compute(){
  // читання полів
  var area     = num($('area').value);
  var baseType = $('baseType').value;            // 'pvc' | 'al'

  // перевірка: чи завантажені ціни
  if (!PR){
    console.warn('Ціни ще не завантажені');
    $('total').innerText   = '0 грн';
    $('explain').innerText = '';
    $('minNote').innerText = '';
    return { total:0, area:area, basePrice:0 };
  }

  // база з JSON
  var basePrice = (baseType === 'al') ? PR.base.aluminium : PR.base.pvc;

  // за метри з JSON
  var shadow   = num($('shadowLen').value)   * PR.perMeter.shadow.price;
  var floating = num($('floatLen').value)    * PR.perMeter.floating.price;
  var cornice  = num($('corniceLen').value)  * PR.perMeter.cornice.price;
  var decor    = num($('decorLen').value)    * PR.perMeter.decor.price;
  var tracks   = num($('tracksLen').value)   * PR.perMeter.tracks.price;
  var cable    = num($('cableLen').value)    * PR.perMeter.cable.price;

  // по штуках з JSON
  var spots = num($('spots').value)          * PR.perPiece.spots.price;
  var chand = num($('chandeliers').value)    * PR.perPiece.chandeliers.price;
  var vents = num($('vents').value)          * PR.perPiece.vents.price;

  // підсумки
  var base     = area * basePrice;
  var byMeter  = shadow + floating + cornice + decor + tracks + cable;
  var byPieces = spots + chand + vents;
  var subtotal = base + byMeter + byPieces;

  // ручна націнка/знижка (%)
  var adjPct = num($('adjPct').value);
  if (adjPct !== 0) subtotal = subtotal * (100 + adjPct) / 100;

  // авто-знижка за великі площі
  var autoDiscApplied = false;
  if (area > PR.rules.discountThresholdM2){
    subtotal *= (100 - PR.rules.discountPercent) / 100;
    autoDiscApplied = true;
  }

  // мінімальне замовлення
  var MIN   = PR.rules.minOrderUAH;
  var total = Math.max(MIN, Math.round(subtotal));

  // пояснення
  var parts = [
    'База: ' + area + ' м² × ' + basePrice + ' = ' + UAH(base) + ' грн',
    'Довжина/м.пог: ' + UAH(byMeter) + ' грн',
    'Поштучно: ' + UAH(byPieces) + ' грн'
  ];
  if (adjPct){
    parts.push((adjPct > 0 ? 'Націнка ' : 'Знижка ') + adjPct + '% застосована');
  }
  if (autoDiscApplied){
    parts.push('Авто-знижка ' + PR.rules.discountPercent +
               '% (площа > ' + PR.rules.discountThresholdM2 + ' м²)');
  }

  $('explain').innerText = parts.join(' · ');
  $('total').innerText   = UAH(total) + ' грн';
  $('minNote').innerText = (total === MIN)
    ? 'Застосовано мінімальне замовлення ' + MIN + ' грн. Санвузли та ванні при окремому монтажі рахуються за мінімальним замовленням.'
    : '';

  return { total: total, area: area, basePrice: basePrice };
}

// ===== Надіслати заявку =====
async function openOrder(){
  try{
    var data  = compute();
    var name  = prompt("Вкажіть ваше ім'я:");
    if (!name) return;
    var phone = prompt("Ваш телефон (+380…):");
    if (!phone) return;
    var note  = prompt("Коментар (необов'язково):") || '';

    var payload = {
      name, phone,
      message: 'Замовлення з калькулятора. Сума: ' + data.total + ' грн. ' + note
    };

    var resp = await fetch('/api/telegram-submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!resp.ok){
      var t = await resp.text();
      throw new Error('HTTP ' + resp.status + ': ' + t);
    }
    alert('Дякуємо! Заявку надіслано, ми зв\'яжемось з вами.');
  }catch(e){
    console.error(e);
    alert('Не вдалося надіслати. Спробуйте ще раз або напишіть у Telegram.');
  }
}
// ===== Прив’язка подій та старт =====
function bindLive(){
  // перший перерахунок після завантаження цін викликаємо окремо в initCalculator
  $('calcBtn')  && $('calcBtn').addEventListener('click', compute);
  $('orderBtn') && $('orderBtn').addEventListener('click', openOrder);

  var nodes = document.querySelectorAll('input,select');
  for (var i=0; i<nodes.length; i++){
    nodes[i].addEventListener('input', compute);
    nodes[i].addEventListener('change', compute);
  }
}

async function initCalculator(){
  PR = await loadPrices();
  bindLive();
  compute();
}

if (document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', initCalculator);
}else{
  initCalculator();
}
</script>
<script>
// ===== Helpers =====
function num(v){ var n = +v; return isFinite(n) ? n : 0; }
function UAH(n){ return new Intl.NumberFormat('uk-UA').format(Math.round(n)); }
function $(id){ return document.getElementById(id); }

// ===== Глобальні ціни з JSON =====
let PR = null;

async function loadPrices(){
  const resp   = await fetch('prices.json');
  const prices = await resp.json();
  console.log('Ціни завантажені:', prices);
  return prices;
}

// ===== Основний перерахунок =====
function compute(){
  // читання полів
  var area     = num($('area').value);
  var baseType = $('baseType').value;            // 'pvc' | 'al'

  // перевірка: чи завантажені ціни
  if (!PR){
    console.warn('Ціни ще не завантажені');
    $('total').innerText   = '0 грн';
    $('explain').innerText = '';
    $('minNote').innerText = '';
    return { total:0, area:area, basePrice:0 };
  }

  // база з JSON
  var basePrice = (baseType === 'al') ? PR.base.aluminium : PR.base.pvc;

  // за метри з JSON
  var shadow   = num($('shadowLen').value)   * PR.perMeter.shadow.price;
  var floating = num($('floatLen').value)    * PR.perMeter.floating.price;
  var cornice  = num($('corniceLen').value)  * PR.perMeter.cornice.price;
  var decor    = num($('decorLen').value)    * PR.perMeter.decor.price;
  var tracks   = num($('tracksLen').value)   * PR.perMeter.tracks.price;
  var cable    = num($('cableLen').value)    * PR.perMeter.cable.price;

  // по штуках з JSON
  var spots = num($('spots').value)          * PR.perPiece.spots.price;
  var chand = num($('chandeliers').value)    * PR.perPiece.chandeliers.price;
  var vents = num($('vents').value)          * PR.perPiece.vents.price;

  // підсумки
  var base     = area * basePrice;
  var byMeter  = shadow + floating + cornice + decor + tracks + cable;
  var byPieces = spots + chand + vents;
  var subtotal = base + byMeter + byPieces;

  // ручна націнка/знижка (%)
  var adjPct = num($('adjPct').value);
  if (adjPct !== 0) subtotal = subtotal * (100 + adjPct) / 100;

  // авто-знижка за великі площі
  var autoDiscApplied = false;
  if (area > PR.rules.discountThresholdM2){
    subtotal *= (100 - PR.rules.discountPercent) / 100;
    autoDiscApplied = true;
  }

  // мінімальне замовлення
  var MIN   = PR.rules.minOrderUAH;
  var total = Math.max(MIN, Math.round(subtotal));

  // пояснення
  var parts = [
    'База: ' + area + ' м² × ' + basePrice + ' = ' + UAH(base) + ' грн',
    'Довжина/м.пог: ' + UAH(byMeter) + ' грн',
    'Поштучно: ' + UAH(byPieces) + ' грн'
  ];
  if (adjPct){
    parts.push((adjPct > 0 ? 'Націнка ' : 'Знижка ') + adjPct + '% застосована');
  }
  if (autoDiscApplied){
    parts.push('Авто-знижка ' + PR.rules.discountPercent +
               '% (площа > ' + PR.rules.discountThresholdM2 + ' м²)');
  }

  $('explain').innerText = parts.join(' · ');
  $('total').innerText   = UAH(total) + ' грн';
  $('minNote').innerText = (total === MIN)
    ? 'Застосовано мінімальне замовлення ' + MIN + ' грн. Санвузли та ванні при окремому монтажі рахуються за мінімальним замовленням.'
    : '';

  return { total: total, area: area, basePrice: basePrice };
}

// ===== Надіслати заявку =====
async function openOrder(){
  try{
    var data  = compute();
    var name  = prompt("Вкажіть ваше ім'я:");
    if (!name) return;
    var phone = prompt("Ваш телефон (+380…):");
    if (!phone) return;
    var note  = prompt("Коментар (необов'язково):") || '';

    var payload = {
      name, phone,
      message: 'Замовлення з калькулятора. Сума: ' + data.total + ' грн. ' + note
    };

    var resp = await fetch('/api/telegram-submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!resp.ok){
      var t = await resp.text();
      throw new Error('HTTP ' + resp.status + ': ' + t);
    }
    alert('Дякуємо! Заявку надіслано, ми зв\'яжемось з вами.');
  }catch(e){
    console.error(e);
    alert('Не вдалося надіслати. Спробуйте ще раз або напишіть у Telegram.');
  }
}
// ===== Прив’язка подій та старт =====
function bindLive(){
  // перший перерахунок після завантаження цін викликаємо окремо в initCalculator
  $('calcBtn')  && $('calcBtn').addEventListener('click', compute);
  $('orderBtn') && $('orderBtn').addEventListener('click', openOrder);

  var nodes = document.querySelectorAll('input,select');
  for (var i=0; i<nodes.length; i++){
    nodes[i].addEventListener('input', compute);
    nodes[i].addEventListener('change', compute);
  }
}

async function initCalculator(){
  PR = await loadPrices();
  bindLive();
  compute();
}

if (document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', initCalculator);
}else{
  initCalculator();
}
</script>
